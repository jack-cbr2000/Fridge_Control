name: Build and Release ESP32 Firmware

on:
  push:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup PlatformIO
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    - name: Build firmware
      run: pio run

    - name: Create version info file
      run: |
        echo "${{ github.event.release.tag_name || 'development' }}" > firmware.version
        echo "build_timestamp=$(date +%s)" >> firmware.version
        echo "git_commit=${{ github.sha }}" >> firmware.version
        echo "repository=${{ github.repository }}" >> firmware.version
        cat firmware.version

    - name: Rename firmware binaries with version
      run: |
        VERSION_TAG="${{ github.event.release.tag_name || github.run_number }}"
        cp .pio/build/esp32dev/firmware.bin firmware-${VERSION_TAG}.bin
        cp .pio/build/esp32dev/bootloader.bin bootloader-${VERSION_TAG}.bin
        cp .pio/build/esp32dev/partitions.bin partitions-${VERSION_TAG}.bin

        # Create checksums for verification
        sha256sum firmware-${VERSION_TAG}.bin > firmware-${VERSION_TAG}.bin.sha256
        sha256sum bootloader-${VERSION_TAG}.bin > bootloader-${VERSION_TAG}.bin.sha256
        sha256sum partitions-${VERSION_TAG}.bin > partitions-${VERSION_TAG}.bin.sha256

    - name: Upload firmware as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-binaries
        path: |
          firmware-*.bin
          firmware.version
          *.sha256

    - name: Create Release with firmware
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware-${{ github.event.release.tag_name }}.bin
          bootloader-${{ github.event.release.tag_name }}.bin
          partitions-${{ github.event.release.tag_name }}.bin
          firmware.version
          *.sha256
        body: |
          ## ESP32 Dual Zone Fridge Controller Firmware ${{ github.event.release.tag_name }}

          ### Automatic OTA
          ESP32 devices will automatically detect and install this update when connected to WiFi.

          ### Files
          - `firmware-*.bin`: Main firmware binary
          - `bootloader-*.bin`: ESP32 bootloader
          - `partitions-*.bin`: ESP32 partition table
          - `firmware.version`: Version and metadata information
          - `*.sha256`: SHA256 checksums for verification

          ### Installation
          For manual installation, use `firmware-*.bin` with PlatformIO, Arduino IDE, or `esptool.py`.

          ### SHA256 Checksums
          ```
          $(cat *.sha256)
